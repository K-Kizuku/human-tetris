# 人間テトリス — MVP 仕様書（iOS 18 / カメラ + 2D）v1.1

最終更新：2025-08-16
対象：iPhone（iOS 18 以降）
言語：Swift
主要フレームワーク：AVFoundation / Vision / Accelerate（vImage） / SpriteKit（または SwiftUI Canvas）

---

## 0. 要約（Executive Summary）

- **他撮り・協力プレイ前提**：撮影者が端末を操作し、被写体がポーズでピースを生成。
- **2D テトリス**：MVP で **左右移動／回転** を実装。自動落下・ライン消去あり。
- **カメラオーバーレイ**：ライブ映像上に **4（縦）×3（横）** の計測枠を重ね、人物領域を量子化してピース化。
- **可変ポリオミノ**：ピースは **3〜6 セル** の連結形（ポリオミノ）。
- **オンデバイス認識**：人物セグメンテーション＋骨格推定 → 量子化 → 最適連結セルの抽出。

---

## 1. 目的・コンセプト

- **目的**：人間のポーズをダイレクトにピースへ変換し、"見る・撮る・ポーズする・積む" の一体感を提供。イベントで短時間に盛り上がる体験を重視。
- **体験の核**：

  1. 被写体がポーズを取る
  2. 画面の **4×3 枠** 内の人物領域を量子化
  3. 連結セル（3〜6）を抽出してピース化
  4. **2D の盤面**に落下 → ライン消去 → スコア

- **非目標（MVP）**：AR 表示、オンライン機能、クラウド連携、映像保存の作り込み。

---

## 2. 用語と表記

- **ポリオミノ**：連結正方形セルからなる図形。本作では **3〜6 セル** を対象（テトロミノはその一種）。
- **ROI**（Region of Interest）：画面に重ねて表示する **4（縦）×3（横）** の計測枠。
- **IoU**（Intersection over Union）：量子化結果と候補形状の一致度（0.0–1.0）。
- **安定時間**：確定直前の連続フレームで姿勢が維持された時間。
- **同形（shape equivalence）**：平行移動・回転・反転を許す一致。正規化署名 `shapeId` で判定。

---

## 3. 想定ユースケース（MVP）

- **人数**：1〜3 名（撮影者 1 ＋被写体 1〜2 ＋観客）。
- **場所**：屋内イベント、教室、会議室等。背景は単色推奨。
- **端末持ち方**：背面カメラで被写体を正面から撮影。撮影者が **片手で操作** できる UI。

---

## 4. ゲームルール（MVP）

- **盤サイズ**：10×20。
- **ピース生成**：Play 画面上部のカメラ領域で 3 秒カウントダウン後にスナップショット → 4×3 量子化 → 3〜6 セルの連結集合を抽出。
- **出現位置**：ON セル重心の **X 座標** から初期列を決定（0〜9 列へマッピング）。
- **操作**：

  - **左右移動**（ボタン or スワイプ）
  - **回転（時計回り）**／長押しで**反時計回り**（オプション）
  - **一時停止／再開／リトライ**

- **落下**：自動落下。接地後にロック。ラインは同時消去可。
- **ピース順**：ユーザーポーズ駆動＋（失敗時）フォールバック。ランダムは**フォールバック時**および同点タイブレークに限定。
- **次ピース規則**：基本はカメラ由来。抽出失敗（3 未満/6 超/同形重複/人物未検出）の場合のみ、7 種テトロミノから等確率フォールバック。
- **スコア**：①IoU、② 安定時間、③ 同時消去ライン数（1〜4）、④**形状多様性ボーナス**。
- **終了条件**：盤上部到達でゲームオーバー。

---

## 5. 体験フロー

1. **起動**：カメラ許可／安全注意（転倒・ストレッチ禁止、第三者の写り込み配慮）。
2. **フレーミング**：Play 画面上部のカメラ領域に 4×3 枠を常時表示。
3. **次ピース準備（埋め込み）**：落下中に“次ピース生成カウントダウン（3→2→1→0）”を進行。
4. **0 秒で判定スナップショット** → 次ピース確定または失敗時フォールバック。
5. **落下・操作**：確定した“次ピース”がキューから盤面 2D 盤面に出現 → 左右・回転操作 → 接地 → ライン消去演出。
6. **継続**：次のポーズヒント表示。
7. **終了**：スコア要約 → 再挑戦／スクリーンショット共有（保存は手動）。

---

## 6. 認識・量子化パイプライン

- **人物抽出**：`VNGeneratePersonSegmentationRequest`（中品質・フレームレート優先）。
- **骨格補助**：`VNDetectHumanBodyPoseRequest`（姿勢妥当性・チート抑止）。
- **4×3 量子化**：

  - ROI でマスクをクロップし、各セルの **占有率**（0.0–1.0）を算出。
  - 自動閾値 `θ` で ON/OFF 化（初期 0.45、環境適応 0.35–0.55）。
  - 小連結成分除去・モルフォロジーでノイズ低減。

- **連結セル抽出（3〜6）**：

  - 占有率の高いセルを優先しつつ、**連結性制約**（4 近傍）を満たす **k∈{3,4,5,6}** の部分集合を探索。
  - 目的関数：`score = w1*占有率合計 + w2*連結度 + w3*形状多様性 + w4*目標一致度 - w5*細長さ罰則`。
  - 近似手法：上位セルからのビームサーチ（幅 8〜12）＋早期枝刈り（上界推定）。

- **初期列決定**：ON セルの **重心 X**（0.0–1.0）→10 列へ線形マッピング。
- **取得タイミング**：カウント 0 秒の単発スナップショットを基準に判定（安定時間は `-0.20s〜0` 秒の移動平均で代替）。
- **形状確定条件**：セル数 3〜6 かつ `IoU ≥ 0.60`（候補形状基準）かつ “直近 3 ピースと同形でない”。
- **不成立時**：フォールバックルールを適用（§8.2）。

---

## 7. 2D レンダリング仕様（SpriteKit / SwiftUI Canvas）

- **描画**：上部にカメラプレビュー（4×3 枠＋透過色のセル塗りつぶし＆ゴースト）、中央に盤面、下部に操作 UI。
  - カメラ領域には“次ピース候補”を示す半透明セルを重ね、カウントダウン中は色付きでハイライトする。
- **アニメーション**：

  - 落下：**1 マス 200–350ms** のイージング。
  - 接地／ロック：小さなバウンス。
  - ライン消去：行発光 → 縮退 → 上詰め（300–450ms）。

- **入力 UI**：画面下に **左／回転／右** の 3 ボタン（親指届きやすい距離）。スワイプ操作も選択可。

---

## 8. UI / UX

- **ライブガイド**：セル占有率ヒートマップ、「腕を上」「右へ半歩」などのヒント。
- **状態表示**：IoU バー、安定タイマー、次の推奨サイズ（例：5 セル）。
- **サウンド**：3-2-1 ビープ、ロック SE、消去 SE。
- **安全配慮**：顔モザイク（任意 ON）、過度な関節角度検出時の注意表示。
- **カウントダウン UI**：中央数値＋円形プログレス、ビープ音（1Hz）、0 秒でシャッター SE。
- **透過セル**：検出された ON セルを色付き半透明で塗り、成功時は緑、失敗時は赤で一瞬ハイライト。
- **“次ピース”バッジ**：盤面上部に「現ピース」「次ピース」のラベル（スクリーンショット参照）を表示。

### 8.1 ヒント生成ポリシー（Board-driven Targeting）

**目的**：任意ポーズ生成を尊重しつつ、盤面にとって有益で多様な形へ“やさしく誘導”。

**入力**：

- 盤面特徴：列高ベクトル h\[0..9]、表面粗さ、穴/被覆不能マス数、井戸深さ、オーバーハング位置
- 多様性状態：直近 N 手のサイズ・細長さ・凹凸の分布
- クールダウン状態：細長形などの一時的禁止/厳格化
- ミッション（任意 ON）：推奨サイズ k、アスペクト、凸部位置など

**ターゲット仕様（TargetSpec）**：`{ k∈{3..6}, aspect∈{slender,wide,balanced}, convexity∈{none,left,right,center}, rot∈{0..3}, centroidX∈[0,9] }`

**決定アルゴリズム**：

1. 盤面ヒューリスティクスで複数の TargetSpec をスコアリング（穴削減、ライン成立見込み、表面平坦化）。
2. クールダウン・多様性・ミッションで重み付けして最上位の TargetSpec を選択。
3. 検出パイプラインの目的関数 `score` に TargetSpec との一致項（w4）を付与し、IoU 閾値を**緩和**（優先形）／**強化**（回避形）。

**UI ヒント生成**：

- 4×3 ゴースト表示：目標セル ON/OFF を薄色で重ねる。
- 骨格差分 → 短文指示：肩/肘/膝/腰の差分ベクトルから「右腕を水平に」「左に体を傾ける」「右膝を曲げる」等を自動生成。
- 進捗メーター：`match = α*IoU + β*関節一致度` をバー表示（確定条件に直結）。

**例**：

- 井戸深さ ≥4 かつ クールダウン中でない → `aspect=slender, k=4 or 5, rot=縦, centroidX=井戸列` を提示。
- 穴多発＆凹凸大 → `aspect=wide, k=5 or 6, convexity=left/right` でブリッジ形を提示。
- ミッション「k=5・幅広」ON → その条件に合う TargetSpec にボーナス。

**失敗時の扱い**：

- 目標から外れた形でも閾値を満たせば採用。ただし多様性ボーナス低下・次手の誘導を強化。

### 8.2 次ピース生成（3 秒カウントダウン）

- タイミング：常に「次ピース」枠を準備。現在のピースがロックされた瞬間、準備済みの次ピースを盤面へ出現。
- 進行：
  1. カメラ領域で 3→2→1 の数値表示とビープ音（各 1 秒）。
  2. 0 秒でフレームをスナップショットし、4×3 量子化 → 連結部分集合（3〜6 セル）抽出を実行。
  3. カメラ領域には、検出された ON セルを“色付き透過セル”で重ねて可視化。
- 成功条件：抽出セル数が 3〜6、かつ形状が直近 3 ピースと**同形でない**（回転・反転を含めて同一とみなす）。
- 失敗条件：
  - ON セルが 3 未満または 6 超
  - 形状が直近 3 ピースと同形（回転・反転同一）
  - セグメンテーション失敗（人物未検出）
- 失敗時フォールバック：7 種テトロミノから等確率で 1 つを生成（同形 3 連続は避ける軽い抑制を適用）。
- 同形判定：セル座標を原点正規化し、全回転（0/90/180/270）と水平反転の中で辞書順最小の署名 `shapeId` を採用。直近 3 ピースの `shapeId` に一致したら同形。
- UI：
  - カウント数（大表示）＋円形プログレス
  - 0 秒時に“カシャ”SE と軽い画面フラッシュ
  - 成功：緑系の発光、失敗：赤系のバイブ/表示（視認性を最小限）

---

## 9. 技術構成

- **カメラ**：AVFoundation（`AVCaptureVideoDataOutput`）。
- **認識**：Vision（人物セグ／ポーズ）、Accelerate/vImage（縮約・統計）。
- **ゲーム**：`GameCore`（純 Swift）に盤面・衝突・ライン消去・操作を集約。
- **描画**：SpriteKit（推奨）または SwiftUI Canvas。
- **並列実行**：認識はバックグラウンド、UI はメイン。60fps 目標。
- **データ**：画像・動画は保存しない（スクリーンショットのみ手動）。

---

## 10. コアアルゴリズム（擬似 Swift）

```swift
struct Grid4x3 { var on: [[Bool]] } // 4 rows x 3 cols

func quantize(mask: CVPixelBuffer, roi: CGRect, threshold: Float) -> Grid4x3 {
    // ROI切り出し → 4x3へ平均縮約 → セル占有率 > threshold
}

struct Polyomino {
    let cells: [(x: Int, y: Int)] // 連結セル（3..6）
    let rot: Int
    let size: Int { cells.count }
}

func bestConnectedSubset(from g: Grid4x3) -> Polyomino? {
    // 占有率の高いセルを優先し、k∈{3,4,5,6} の連結部分集合をビームサーチで抽出
    // score = w1*占有率 + w2*連結度 + w3*多様性 + w4*目標一致 - w5*細長さ罰則
}

func spawnColumn(for g: Grid4x3) -> Int {
    // ONセルの重心X ∈ [0, 1] を 0..9 にマッピング
}

protocol GamePieceProvider {
    func beginCountdown()              // 3秒開始
    func cancelCountdown()
    func captureAtZero() -> Polyomino? // 0秒スナップショット→成功なら形状、失敗ならnil
    func fallbackTetromino() -> Polyomino // 7種から等確率
}
```

---

## 11. パフォーマンス要件（MVP）

- **端末**：iPhone 12 以降で **30fps 以上**、iPhone 15 以降で **60fps 目標**。
- **推論解像度**：短辺 256〜320（端末性能で可変）。
- **遅延**：撮影 → ピース確定まで **≤ 250ms（中央値）**。

---

## 12. プライバシー・安全

- **オンデバイス処理**：画像は端末内で処理し、**自動保存しない**。
- **第三者の写り込み**：顔検出で自動モザイク（任意 ON）。
- **安全注意**：無理なポーズを避け、周囲の障害物に注意。体調・服装にも配慮。
- **年齢区分**：軽運動コンテンツとしての注意表示。

---

## 13. テレメトリ（オフライン）

- **収集**：匿名統計（平均 IoU、平均安定時間、総ライン数、プレイ時間、**形状多様性**）。
- **送信**：MVP では送信なし（端末内に保持、デバッグ用途）。

---

## 14. 画面と遷移

- **Home**：Start／How to／Settings（安全・モザイク・難易度・操作方法）。
- **Framing**：4×3 枠表示・距離ガイド。
- **Play**：画面上部にカメラプレビュー（4×3 枠オーバーレイ＋ゴースト）／中央に盤面／下部に左右・回転ボタン。
  - カメラ領域は「次ピース生成専用」ビューとして常設（埋め込み）。現在の落下ピース進行と並行して“次ピース”を準備する。
- **Result**：スコア、最高 IoU、総ライン、**多様性指数**、再挑戦。

---

## 15. 設定（MVP）

- **難易度**：

  - Easy：`θ=0.40`、`IoU ≥ 0.55`、`安定 ≥ 0.30s`
  - Normal：`θ=0.45`、`IoU ≥ 0.60`、`安定 ≥ 0.40s`
  - Hard：`θ=0.50`、`IoU ≥ 0.70`、`安定 ≥ 0.50s`

- **モザイク**：ON / OFF
- **操作**：ボタン／スワイプ（選択可）

---

## 16. テスト計画と受け入れ基準

- **環境頑健性**：屋内/屋外・明暗差で IoU 0.60 達成率 ≥ 80%。
- **操作レスポンス**：距離 2.0m±0.5m で確定までの平均時間 ≤ 2.0s。
- **誤確定**：無人での確定 0 件 / 100 試行。
- **安定性**：連続 15 分プレイでフリーズ・クラッシュなし。
- **多様性**：同サイズ・同細長形の連続発生が 5 回以内に 1 回未満（抑制が効いている）。

---

## 17. 開発タスク（2〜3 週間目安）

1. `GameCore`：盤面・衝突・ライン消去・操作（左右/回転）
2. AVFoundation パイプライン（プレビュー／フレーム取得）
3. Vision パイプライン（人物セグ＋ポーズ）
4. 4×3 量子化／連結部分集合探索／重心列マッピング
5. ライブガイド UI（ヒートマップ・バー・ヒント）
6. 2D 描画（SpriteKit）とアニメーション
7. 安全・プライバシ UI／オンボーディング
8. 設定・難易度・結果画面
9. 性能最適化（解像度可変／スロットリング）
10. テスト／QA（屋内外・複数端末）

---

## 18. 既知のリスクと対策

- **照明・背景依存**：適応的閾値＋ノイズ除去＋背景シンプル推奨のガイダンス。
- **手ブレ**：連続フレームの低パス化＋ロック遅延バッファ。
- **チート（紙・物体）**：骨格ランドマーク非検出時は無効化。
- **距離差の不公平**：ROI スケール正規化＋距離ガイド必須化。

---

## 19. バランス設計：I 型スパム（直立ポーズ偏重）対策

**懸念**：直立ポーズが最も取りやすく、積みやすいため、同形反復でゲーム性が崩壊する恐れ。

**対策アイデア（併用推奨）**：

1. **形状多様性ボーナス／重複ペナルティ**

   - 直近 N 個（例：8 個）のピースについて、**サイズ分布**・**アスペクト比（細長さ）**・**凹凸特性** のエントロピーを算出し、多様なほどスコア倍率 ↑。
   - 同じサイズかつ細長形（縦長比>2.5 など）の連続生成には段階的ペナルティ。
   - 実装：`diversityIndex ∈ [0,1]` をスコア式の係数に反映。

2. **目標提示（ターゲット・ブリーフィング）**

   - 毎手、**推奨サイズ k** と **推奨アスペクト** を提示。これに近いほど確定閾値（IoU/安定時間）を緩和・スコア加点。
   - 逆に不一致が継続すると確定閾値を厳格化（直立連打は難しくなる）。

3. **シェイプクールダウン**

   - 細長形（I 相当）の採用後、**同系の形状だけ IoU 閾値を+0.05〜0.10**、一定手数で解除。
   - ユーザーには「次は幅広の形を狙おう！」等のヒントを表示。

4. **サイズ在庫（Shape Budget）**

   - サイズごとに使用回数ゲージを設け、使用すると消費。ライン消去や多様性達成で回復。
   - 直立のみでは在庫が枯渇し、**自然に別サイズを要求**。

5. **列ヘルス（Well Health）**

   - 同一列への連続出現や縦井戸形成を検知すると、**スポーン列にオフセット** を付与（±1〜2 列のランダムドリフト）。
   - 直立スパムでの単調積みを崩す。

6. **動作要求（Motion Gate）**

   - 前回から **主要関節角度の変化量合計** が閾値未満なら「同一姿勢判定」で不採用。
   - 直立連打を防ぎ、**毎手でポーズの変化** を促す。

7. **ミッション（任意 ON）**

   - 「次は 5 セルで幅広」「凸部 1 つの形」などのミッションをランダム提示。達成でボーナス、未達でも通常スコア。

---

## 20. 拡張アイデア（MVP 以降）

- 本格ルール（SRS 回転／T スピン／ホールド／7 バッグ）。
- 2 人合体ピース（例：2 人で 5〜6 セルの複合形）。
- AR 表示対応、キャスト／外部ディスプレイ出力。
- BGM テンポ同期、チュートリアル強化。

---

## 21. データモデル（簡易）

```swift
struct GameState { var board: [[Cell]]; var score: Int; var lines: Int }
struct CaptureState {
    var grid: Grid4x3
    var iou: Float
    var stableMs: Int
    var countdown: Int           // 3..0
    var snapshotAtZero: Bool     // 0秒で取得したか
    var shapeId: String?         // 正規化署名（回転・反転を含め同形判定用）
}
struct Settings { var difficulty: Difficulty; var mosaic: Bool; var inputStyle: InputStyle }
```

---

## 22. Definition of Done（MVP）

- 指定端末でプレイ可能（30fps 以上）。
- 一般ユーザー試遊 5 回で「面白い／ウケる」評価が**7 割以上**。
- 認識・盤面・UI で主要クラッシュ**ゼロ**。
- プライバシー／安全の明示と実装完了（保存なし・モザイク）。
- **I 型対策の効果**：多様性指数が中位以上、細長形の連続生成率が目標値以下。

---

## 23. 実装メモ（Tips）

- Vision 推論は `AVCaptureVideoDataOutput` の低解像度支流で実行し、統計のみ UI へ渡す。
- 占有率は `vImage` でブロック平均化すると高速。4×3 なら固定カーネルで最適化可。
- 連結部分集合の探索は **事前に全形状（3〜6 セル）の正規形** を生成・キャッシュしておくと IoU 計算が安定。
- スコア式の重み `w1..w5` はテレメトリでチューニング。

---

## 24. 実装計画（Next Steps）

**Phase A：リポジトリ/骨格（Day 1–2）**

- Xcode プロジェクト作成（モジュール：`GameCore` / `Capture` / `UI`）。
- `GameCore` スケルトン（盤面・ピース型・衝突・ライン消去・左右/回転）。
- `Capture` の AVFoundation 配管（プレビュー+フレーム取得のみ）。

**Phase B：認識・量子化（Day 3–5）**

- Vision 人物セグ+ポーズ導入、4×3 量子化の実装（vImage ブロック平均）。
- 連結部分集合探索（ビームサーチ）をスタブ → ユニットテスト（合成マスク 20 種）。

**Phase C：統合と UI（Day 6–8）**

- 生成ピース →`GameCore`へ流し込む。スポーン列マッピング・回転実装・キック対応。
- 入力 UI（左/回転/右）とアニメーション（落下/消去）。

**Phase D：バランス機能（Day 9–11）**

- 形状多様性ボーナス/重複ペナルティ、シェイプクールダウン、ミッション（任意 ON）。
- 8.1 のターゲット仕様に基づくヒント生成（ゴースト/短文指示）。

**Phase E：最適化と QA（Day 12–14）**

- 遅延計測、解像度可変/スロットリング、クラッシュ/リーク検査。
- 受け入れ基準（§16）を満たすまで調整。

---

## 25. スコア式とパラメータ初期値

### 25.1 候補形状（検出）スコア

候補部分集合 S（セル数 k∈{3,4,5,6}）に対して：

score(S) = w1 \* 占有率合計 + w2 \* 連結度 + w3 \* 予測多様性寄与 + w4 \* TargetSpec 一致 - w5 \* 細長さ罰則

- 占有率合計 = Σ s_c（各セルの占有率 0..1）
- 連結度 = E(S) / (2k)（4 近傍の内部エッジ数を正規化、0..1）
- 細長さ罰則 = max(0, aspect(S) - a0)、aspect(S) = max(h/w, w/h)、a0 = 1.8
- TargetSpec 一致（0..1）：サイズ/アスペクト/凸部/回転/centroidX の一致度
- 予測多様性寄与（0..1）：直近 N 手のサイズ × アスペクト分布に対する多様性増分（§27）

初期重み（端末内調整可）：w1=1.0, w2=0.45, w3=0.25, w4=0.60, w5=0.35

採用条件：IoU ≥ 0.60 かつ 安定時間 ≥ 0.40s。

### 25.2 ゲームスコア（確定後）

gameScore = α \* linesBonus + β \* IoU + γ \* stable + δ \* diversityIndex

- linesBonus：1,3,5,7 点（1〜4 ライン）
- IoU：0..1 を ×10 にスケール
- stable：安定時間（上限 1.0s）×5
- diversityIndex：§27 の 0..1 を ×5
- 初期：α=4, β=10, γ=3, δ=5

---

## 26. 連結部分集合探索（ビームサーチ）詳細

- 入力：4×3 セルの占有率行列 S ∈ \[0,1]^(4×3)。
- 手順：

  1. 占有率上位 M（例：M=8）セルを起点に選択。
  2. 各起点から 4 近傍拡張で連結集合を増やし、サイズ k（3..6）に到達するまでビーム幅 B（8〜12）で展開。
  3. 各ノードで score(S) の上界を計算して枝刈り（未選択セルの上位占有率を加えた理論最大）。
  4. 完成形を評価してベストを返す。同点はランダムでタイブレーク可。

- 計算量：12 セル規模のため端末内で十分高速（<1ms 想定）。

---

## 27. 形状多様性ボーナス実装

- 履歴ウィンドウ：直近 N=8 手。
- 分類ビン：サイズ{3,4,5,6} × アスペクト{slender(≥2.0), balanced(1.2–2.0), wide(≤1.2)}＝ 12 ビン。
- 多様性指数：H = -Σ p_i log p_i、Hmax = log 12、diversityIndex = H / Hmax（0..1）。
- 重複ペナルティ：同一ビンが r 回連続 → penalty = 0.05 × (r-1) をゲームスコアから減算（上限 0.20）。

---

## 28. シェイプクールダウン実装

- 対象：細長形（aspect≥2.0）または高さ優勢（h≥k-1 かつ w≤2）。
- 発動：対象採用後、cooldown = 3 手。
- 効果：クールダウン中は対象系形状の IoU 閾値 +0.07、TargetSpec 一致度に -0.10 のバイアス。
- 解除：手数経過で自動解除。幅広形採用で 1 手短縮。

---

## 29. ミッション実装（任意 ON）

- 構造：Mission { id, require: TargetSpec, reward: Int, timeout: Int(=3 手), stacking: Bool }
- 提示：ラウンド開始または前ミッション終了時に 1 件。達成/失敗/タイムアウトで更新。
- 影響：検出スコアの TargetSpec 一致 を +0.15、採用 IoU 閾値を -0.03 緩和。達成時は reward を付与。
- 例：

  - k=5 & aspect=wide（+15 点）
  - convexity=left & centroidX∈\[3,6]（+12 点）
  - k=3 & balanced & rot=1（+10 点）

---

## 30. 回転とキック（可変ポリオミノ）

- ピボット：重心（セル座標の平均）を基準に 90° 回転。
- 離散化：回転後の実数座標を最近傍丸め → 重複セルは 1 つに統合。
- キックテーブル（順）：(0,0),(+1,0),(-1,0),(0,+1),(0,-1),(+2,0),(-2,0) を試行。通れば確定。
- 制約：衝突/境界外なら次のキック。全失敗で回転不成立。
- メモ：SRS 完全互換は目標外。可変形での安定を優先（E2E テストで調整）。

---

## 31. テスト項目（ユニット/結合）

- GameCore：

  - 回転+キックの成立/不成立（境界/障害物/各 k）。
  - ライン消去（1〜4/同時/連続）、ゴースト位置、衝突判定。

- Capture/検出：

  - 4×3 量子化の境界閾値テスト（θ 変動）。
  - ビームサーチの最適性（合成マスクに対して期待形状を選ぶ）。
  - 遅延測定（中央値 ≤250ms）。

- バランス：

  - 多様性指数の上限/下限、重複ペナルティ適用。
  - クールダウン発動/解除、IoU 閾値の上乗せ確認。
  - ミッション提示/達成/失敗フローとスコア反映。

- UX/安全：

  - 顔モザイク ON/OFF、過度な関節角度警告の発火条件。
  - 無人時の誤確定 0 件/100 試行。

- カウントダウン：
  - 3→2→1→0 が 1Hz で正確に進行（±50ms）し、0 秒イベントが 1 回のみ発火。
  - 0 秒時に captureAtZero() が必ず呼ばれる（重複なし）。
- フォールバック：
  - 条件（<3 / >6 / 同形重複 / 未検出）各 50 試行で 100% フォールバック。
  - フォールバック分布が 7 種一様（χ² 検定で有意差なし）。
- 同形判定：
  - 代表 20 形状 × 全回転/反転で `shapeId` が一致、異形では不一致。

---

## 32. 実装上の重要な問題と解決

### 32.1 連続ゲームループの実装 ✅ **解決済み**

**課題**：MVP では 1 つのブロックを落とすとゲーム進行が停止してしまう問題。

**解決策**：

- `GamePieceProvider` プロトコルによるピース提供システム
- `PieceQueue` によるピース事前生成・管理
- `CaptureView` が `GamePieceProvider` を実装し、カメラ入力から連続的にピース生成
- `GameCore.requestNextPiece()` による自動的な次ピース要求

### 32.2 UI フリーズ・デッドロック問題の解決 ✅ **解決済み**

**課題**：「ピース確定」ボタン押下後に画面がフリーズし、テトリス画面に遷移しない問題。

**根本原因**：

- `PieceQueue.preloadPieces()` での同期的な while ループ
- `fillQueue()` でのメインスレッドブロック
- `CaptureView.requestNextPiece()` での待機リスト管理の複雑化

**解決策**：

- **非同期処理の導入**：`DispatchQueue.global()` でバックグラウンド実行
- **DispatchGroup** による並列ピース要求
- **GameView 初期化フローの最適化**：piece provider 設定を遅延実行
- **タイムアウト時間短縮**：5 秒に短縮してレスポンス向上

---

## 33. 実装状況の更新

### 33.1 完了済み機能（2025-08-16 時点）

✅ **基本ゲームシステム**

- 10×20 盤面、衝突判定、ライン消去
- 左右移動・回転操作・キックシステム
- 可変ポリオミノ（3-6 セル）対応

✅ **カメラ・Vision 統合**

- AVFoundation カメラプレビュー・フレーム取得
- Vision 人物セグメンテーション・骨格推定
- 4×3 量子化・連結成分抽出

✅ **連続ゲームループ**

- GamePieceProvider プロトコル
- PieceQueue による事前生成・管理
- 非同期処理による UI フリーズ解決

✅ **UI/UX**

- メイン画面（カメラプレビュー + 4×3 フレーム）
- ゲーム画面（盤面描画・操作ボタン・統計表示）
- IoU・安定時間バー、プログレス表示
- レスポンシブレイアウト（デバイス幅適応）

### 33.2 実装予定機能

🚧 **形状多様性・バランス機能**

- 形状多様性ボーナス/重複ペナルティ
- シェイプクールダウン（I 型スパム防止）
- Board-driven ヒント・TargetSpec

🚧 **高度なアニメーション**

- SpriteKit 統合によるピース落下・ライン消去エフェクト
- パーティクル・サウンドエフェクト

🚧 **最終調整**

- パフォーマンス最適化・テスト
- ユーザビリティ改善
